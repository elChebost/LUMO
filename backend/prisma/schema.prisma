generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Modelos del proyecto
model School {
  id         Int         @id @default(autoincrement())
  name       String
  address    String
  shift      String
  classrooms Classroom[]
  teachers   Teacher[]
  students   Student[]
}

model Classroom {
  id         Int        @id @default(autoincrement())
  name       String
  schoolId   Int
  school     School     @relation(fields: [schoolId], references: [id])
  teacherId  Int
  teacher    Teacher    @relation(fields: [teacherId], references: [id])
  students   Student[]
}

model Teacher {
  id          Int              @id @default(autoincrement())
  name        String
  email       String           @unique
  avatar_url  String?          // ✅ URL del avatar del profesor
  subjects    String
  schedule    String
  role        String
  schoolId    Int
  school      School           @relation(fields: [schoolId], references: [id])
  classrooms  Classroom[]
  students    Student[]
  missions    Mission[]
  profile     TeacherProfile?
}

model Student {
  id                Int                      @id @default(autoincrement())
  name              String
  email             String                   @unique
  password          String
  ci                String?                  @unique // ✅ Cédula de identidad
  age               Int
  level             Int                      @default(1)
  xp                Int                      @default(0)
  schedule          String
  schoolId          Int
  school            School                   @relation(fields: [schoolId], references: [id])
  teacherId         Int
  teacher           Teacher                  @relation(fields: [teacherId], references: [id])
  classroomId       Int
  classroom         Classroom                @relation(fields: [classroomId], references: [id])
  
  // ✅ Estadísticas de habilidades (porcentaje calculado automáticamente)
  statLogic         Int                      @default(0)  // % de veces que eligió Lógica
  statCreativity    Int                      @default(0)  // % de veces que eligió Creatividad
  statLanguage      Int                      @default(0)  // % de veces que eligió Lengua (antes Writing)
  
  // ✅ Contadores de elección de roles (para calcular los porcentajes)
  rolesLogicCount      Int                   @default(0)  // Cantidad de veces que eligió Lógica
  rolesCreativityCount Int                   @default(0)  // Cantidad de veces que eligió Creatividad
  rolesLanguageCount   Int                   @default(0)  // Cantidad de veces que eligió Lengua
  
  // ✅ Métricas generales
  avgTimeMinutes    Int                      @default(0)
  missionsCompleted Int                      @default(0)  // Total de misiones completadas
  isOnline          Boolean                  @default(false)
  
  skillTree         SkillTree?
  subject           Subject?
  profile           StudentProfile?
  missionProgress   StudentMissionProgress[]
}

model SkillTree {
  id         Int      @id @default(autoincrement())
  progress   Int      @default(0)
  xp         Int      @default(0)
  studentId  Int      @unique
  student    Student  @relation(fields: [studentId], references: [id])
}

model Subject {
  id         Int      @id @default(autoincrement())
  name       String
  description String
  studentId  Int      @unique
  student    Student  @relation(fields: [studentId], references: [id])
}

model Mission {
  id               Int                      @id @default(autoincrement())
  nombre           String                   // Nombre de la misión
  descripcionBreve String                   // Descripción breve para cards
  historia         String                   // Historia narrativa completa
  fechaInicio      DateTime                 // Fecha de inicio/activación
  fechaFin         DateTime                 // Fecha de finalización
  imagenURL        String?                  // URL de la imagen
  estado           String                   // "activa", "proxima", "inactiva", "finalizada"
  roles            String                   // JSON con array de 3 roles: [Lógica, Creatividad, Lengua] con emoji, nombre y descripción
  teacherId        Int
  teacher          Teacher                  @relation(fields: [teacherId], references: [id])
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt
  
  // ✅ Relaciones
  studentProgress  StudentMissionProgress[]
}



model StudentProfile {
  id        Int      @id @default(autoincrement())
  avatar    String?
  exp       Int      @default(0)
  coins     Int      @default(0)
  studentId Int      @unique
  student   Student  @relation(fields: [studentId], references: [id])
}

model TeacherProfile {
  id        Int      @id @default(autoincrement())
  avatar    String?
  bio       String?  
  teacherId Int      @unique
  teacher   Teacher  @relation(fields: [teacherId], references: [id])
}

model User {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Contact {
  id        Int      @id @default(autoincrement())
  name      String
  email     String
  message   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ✅ Tabla para progreso de misiones por estudiante
model StudentMissionProgress {
  id              Int      @id @default(autoincrement())
  studentId       Int
  student         Student  @relation(fields: [studentId], references: [id])
  missionId       Int
  mission         Mission  @relation(fields: [missionId], references: [id])
  tasksCompleted  Int      @default(0)
  
  // ✅ Rol elegido: 1=Lógica, 2=Creatividad, 3=Lengua
  selectedRoleId  Int?     // ID del rol seleccionado (1-3)
  selectedRoleName String? // Nombre del rol: "Lógica", "Creatividad" o "Lengua"
  
  status          String   @default("pending") // pending, in_progress, completed
  completedAt     DateTime? // Fecha de completación
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([studentId, missionId]) // Un alumno no puede tener la misma misión dos veces
}

// ✅ Nueva tabla para notificaciones
model Notification {
  id              Int      @id @default(autoincrement())
  title           String
  body            String
  senderId        Int
  targetStudentId Int?     // null = todos
  targetGroup     String?  // nombre del grupo (opcional)
  read            Boolean  @default(false)
  metadata        String?  // JSON con info adicional
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
